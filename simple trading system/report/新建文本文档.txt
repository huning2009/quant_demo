1. 基准策略：
1.1.股票池候选：所有非停牌的A股，按照PE排序，选择PE值最小的前100作为交易标的；
1.2.双均线策略：日K级别，10日均线作为入场信号;开盘前检测信号，金叉买、死叉卖；
1.3.头寸规模确定方法：均仓方案
1.4.测试环境：初始资本1000万；
回测时间设定为a 2015.1.1~2015.12.31；b. 2015.1.1~2018.9.30

2. 回测的改进:
2.1. 引入涨停和跌停的判断，跌停时无法卖出，涨停时无法买入;
2.2. 引入止损的风险控制，如果单日亏损超过3%或者累积亏损超过10%则第二天开盘价卖出；

2.3. 涨跌停计算改进，之前的方案是根据股票名字前2(3)位是否为ST(*ST)来判断是否为st；
为了更精确，故从东财的choice终端下载数据，开始想通过戴帽摘帽日期来判断一个日期是否为ST状态，但后来发现不可行；
比如000008，神州高铁，它的相关日期是这样的：去ST:2013-04-19,去*ST:2008-04-03,....
查得相关数据后，发现在2008-04-03时，仍是ST状态；
而另一只000011, 深物业A , 去*ST:2009-09-16,  在这一天，它同时去掉了*ST和ST的状态；
所以后来通过历史行情方式，把每只票在回测区间内每天的ST和*ST方式下载下来了，因终端对于每次取数条数限制，故分成了4个年份分别取；

ps:这里其实不用下载所有股票的数据，根据上面戴帽摘帽日期表可以筛选出哪些股票曾经ST过, 后面填充is_st字段的时候，采用该方法;

2.4. 在原有的固定比例止损基础上，添加了按固定比例的浮动止损，按回测日当天计算得到的ATR, 动态ATR浮动止损；和按照买入日计算得到的ATR的，静态ATR浮动止损；
2.5. 增加了按ATR分配头寸的方式；

2.6. 将回测中的各种信息打包成一个account，保存回测结果，便于分析。包含的信息比如初始本金，止损方式，止损参数，利润等等；
并将每日的仓位和交易记录保存进account中；(后面打算把选股和择时分别做成一个模块打包进来)

2.7. 将backtest中的回测指标计算和画图功能剥离出去，分为单个account分析和多account分析；
单个account分析会计算年化, 最大回撤, 夏普等值,  将最大回撤算法改进成，每个时间点，最大回撤是多少；
多account分析是将多次的回测结果进行整合，并以图表的形式呈现；(可视化部分还需要优化，特别是当较多的回测净值曲线时，过于混乱)

3. 回测分析
3.1. 2015年单个年份回测中:
ATR头寸分配, 整体收益率均不及均仓的方式, 但观察最大回测，可以发现ATR分配头寸可以有效降低组合风险;
而关于止损的方面，按固定比例浮动止损的效果最好，其次是ATR浮动止损，最差是固定比例止损；
固定比例止损最大回撤和无止损的情况差不多，而且年化收益还大幅降低了。
(ps：怀疑自己代码或者其他地方出了问题)

3.2. 2015.01~2018.09
我们将回测时间拉长, 使用ATR分配头寸后，即便没有使用止损，最大回撤为10%；
年化收益表现最好的是均仓+固定比例浮动止损，不过最大回撤在15以上，而使用ATR分配头寸后，最大回撤在5%左右；

3.3.  我们再来考察按固定比例浮动止损中，从最高点回落比例的设定，3%的最大回撤会小一点；
在单年回测中，3%的年化收益会略低，而时间拉长之后，收益反而略高；

3.4. 后面可以尝试修改ATR的风险系数，看看回测表现会如何，并且可以使用ATR作为退出信号.
尝试用其他的入市信号.

4. 一些感受
别人的代码不能直接拿来用, 即便是课件里的代码，也是有很多小问题;
花在数据上的时间比较多, 而且这么多天下来，也不能确定就完全没有问题;



做了哪些事，在原有的基础上

数据的处理, 涨跌停的处理

加了止损和头寸分配

账户分析
单次回测分析
多次回测分析对比
生成excel表，并画出基本的图
可视化还需要改进
把信号处理陈给一个模块


一些感受
别人的代码不能直接拿来用, 即便是课件里的代码，也是有很多小问题；因为代码只要是人写的，就会出问题。



量化成功的关键要素：
1.胜率
2.赔率
3.交易成本
4.交易频率
5.头寸管理
6.资金规模

这些要素会对策略效果造成直接影响：
胜率考察的是策略赢的比例，赔率是盈亏比；
不同类型，不同市场下，对于策略的胜率和赔率要求是不一样的，比如趋势型策略，胜率通常不高，所以我们需要追求高赔率；
而回复型策略，每次盈利不多，所以要追求胜率；

而其他的要素也会对胜率和赔率造成影响，比如交易成本，有时候会改变策略的胜率和赔率；
而交易频率过高会造成交易成本上升；而交易次数过少，会增加策略执行的不确定性；
如果是回测中，交易频率过低，则策略的可靠性存疑，策略表现好可能是运气。

头寸管理是相当重要的环节，确保你能在市场中长久存活的关键因素，即便99%的胜率，但是重仓操作，那么错一次，就离开了市场。
所以我们需要通过在不相关的品种，不相关的时间段，按照标的的属性(比如波动率)， 以投资组合的形式分配资金，从而分散风险。

而资金的规模，会影响到策略的制定和执行，比如资金量大，则需要一个流动性好，可以容纳大资金的市场或者交易标的，比如像茅台；
而且不同规模的资金，我们设定的目标也要不同，要切合实际情况。

除了上述几点以外，交易标的的选择，入场的时机，止损和止盈都是非常重要的。
止盈确保利润到手，止损能让你有重来的机会。


=========================================================================
通过这几周的学习，对于交易这件事，有了一定的体会，不过还没接受过实盘的洗礼。
很多东西可能只是知道很重要，至于说为什么，没有深刻的体会；
对于实盘，自己想从数据获取，一步步从零开始搭建交易系统，似乎不太现实；但是搭建简单的回测框架，是有必要的，加深对于量化这件事的理解。
所以接下来应该会选择一个市场，选定一种策略去研究，将课上所学融入其中，从回测再到模拟盘，最后逼近实盘；

至于说，还缺少什么，我会这么想，我是否能像职业选手那样提出，思考和解决问题，他们每天在干什么，面对市场，他们关注什么，研究什么?
为什么关注这些?

所以要有work flow & check list.  量化，不仅仅针对的是策略的制定和执行。
对于策略研究者本身，面对市场的瞬息万变，是否有一套方法应对它?

构建一个属于你自己的交易系统，不断的将你对于市场的想法转化成策略，探寻策略的边界，
充分利用量化的优势，验证你的想法，透过回测的结果，修正和改进它，逐步求精。




量化的关键要素：
1.胜率
2.赔率
3.交易成本
4.交易频率
5.头寸管理
6.资金规模

不同类型，不同市场下，对于策略的胜率和赔率要求是不一样的，比如趋势型策略，胜率通常不高，所以我们需要追求赔率


从不同的角度看待这个问题

比如说要做什么样的准备啊，从技术层面，理论层面

现在会什么了，大致知道了工作流程，每个流程中关键核心是什么

每一点都有很多可以谈到的，比如说本金规模，这个会影响到你的策略的选择
周期的长短，趋势还是回复，只调仓不做择时 and so on.

但是你无论选择什么样的策略，你是机构还是散户，但是请做到专业，请遵守上面的规则，而不是头脑发热，感情用事，或者人云亦云，要有自己判断和理解，但是也需要知道大多数人是怎么想的。

work flow & check list



























